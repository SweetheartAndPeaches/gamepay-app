# 代收任务功能说明

## 功能概述

代收任务允许用户接收代收订单，完成代收后获得佣金奖励。

## 核心流程

### 1. 开启代收任务

在 Supabase 数据库的 `system_settings` 表中设置：
```sql
UPDATE system_settings SET value = 'true' WHERE key = 'payin.enabled';
```

### 2. 用户设置代收账户

用户需要在"我的 > 账户管理"中添加代收账户：
- 微信二维码
- 支付宝二维码
- 支付宝账号
- 银行卡

### 3. 领取代收任务

用户可以在"代收任务"页面查看可领取的任务：
- 系统会根据用户余额展示可接收的任务
- 余额必须大于或等于代收金额才能领取
- 每次只能领取一个任务

### 4. 冻结余额

领取任务后，系统会冻结对应的余额：
- 可用余额减少
- 冻结余额增加
- 冻结金额等于代收金额

### 5. 完成代收

用户完成代收后，点击"确认已收到款项"：
- 冻结余额减少（解冻）
- 可用余额增加（代收金额返还）
- 可用余额增加（佣金奖励）

## API 路由

### GET /api/tasks/payin/available

获取可领取的代收任务列表。

**响应示例：**
```json
{
  "success": true,
  "message": "获取任务列表成功",
  "data": {
    "enabled": true,
    "hasAccounts": true,
    "userBalance": 1000,
    "tasks": [
      {
        "id": "uuid",
        "order_no": "PAYIN001",
        "amount": 500,
        "commission": 7.5,
        "status": "pending",
        "expires_at": "2026-02-24T12:00:00Z"
      }
    ],
    "accounts": [...]
  }
}
```

### POST /api/tasks/payin/claim

领取代收任务。

**请求参数：**
```json
{
  "orderId": "uuid",
  "accountId": "uuid"
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "领取任务成功，已冻结余额",
  "data": {
    "order": {...},
    "newBalance": 500,
    "frozenAmount": 500
  }
}
```

### POST /api/tasks/payin/confirm

确认代收完成。

**请求参数：**
```json
{
  "orderId": "uuid"
}
```

**响应示例：**
```json
{
  "success": true,
  "message": "代收完成，奖励已发放",
  "data": {
    "order": {...},
    "orderAmount": 500,
    "commission": 7.5,
    "newBalance": 1007.5
  }
}
```

## 余额变动逻辑

### 领取任务时
```
可用余额 = 原余额 - 代收金额
冻结余额 = 原冻结余额 + 代收金额
```

### 完成代收时
```
冻结余额 = 原冻结余额 - 代收金额
可用余额 = 原可用余额 + 代收金额 + 佣金
```

## 数据库记录

### balance_records 表

代收任务会产生以下记录：

1. **冻结记录**
   - type: `freeze`
   - amount: 代收金额
   - description: `代收任务冻结（订单号：PAYIN001）`

2. **解冻记录**
   - type: `unfreeze`
   - amount: 代收金额
   - description: `代收任务解冻（订单号：PAYIN001）`

3. **佣金记录**
   - type: `task_reward`
   - amount: 佣金金额
   - description: `完成代收任务奖励（订单号：PAYIN001）`

## 注意事项

1. **余额检查**：用户余额必须大于代收金额才能领取任务
2. **账户要求**：必须先设置代收账户才能接收代收任务
3. **单任务限制**：每次只能领取一个代收任务
4. **任务过期**：过期的任务无法领取或完成
5. **系统开关**：可以通过 `payin.enabled` 配置控制代收任务的开启/关闭

## 系统配置

在 `system_settings` 表中可以配置以下参数：

| key | 默认值 | 说明 |
|-----|--------|------|
| payin.enabled | true | 代收任务是否开启 |
| payin.reward_rate | 0.015 | 代收任务奖励率（1.5%） |
| task.expire_minutes | 30 | 任务过期时间（分钟） |

## 示例场景

### 场景 1：正常代收流程

1. 用户余额：1000 元
2. 领取 500 元代收任务
3. 可用余额：500 元，冻结余额：500 元
4. 完成代收，佣金：7.5 元
5. 可用余额：1007.5 元，冻结余额：0 元

### 场景 2：余额不足

1. 用户余额：300 元
2. 尝试领取 500 元代收任务
3. 系统提示：余额不足，需要 500 元

### 场景 3：未设置账户

1. 用户没有设置代收账户
2. 系统提示：请先设置代收账户
3. 引导用户去账户管理页面添加账户

## 常见问题

### Q: 为什么看不到代收任务？

A: 可能的原因：
1. 代收任务未开启（联系管理员开启）
2. 没有设置代收账户
3. 余额不足
4. 暂无符合余额条件的任务

### Q: 冻结的余额什么时候解冻？

A: 代收任务完成后会自动解冻并返还到可用余额。

### Q: 佣金奖励何时到账？

A: 确认代收完成后，佣金奖励会立即到账。

### Q: 可以取消已领取的任务吗？

A: 当前版本不支持取消，只能完成任务或等待任务过期。

### Q: 任务过期了怎么办？

A: 过期的任务会自动失效，冻结的余额会自动解冻返还。

## 后续优化建议

1. 添加任务取消功能
2. 添加代收任务审核流程
3. 添加代收账户限额设置
4. 添加任务优先级排序
5. 添加代收任务统计报表
