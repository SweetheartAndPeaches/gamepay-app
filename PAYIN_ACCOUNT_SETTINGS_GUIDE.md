# 代收账户设置功能说明

## 功能概述

代收账户设置功能允许用户为每个代收账户单独设置金额上限和启用/禁用代收功能，实现更精细化的代收任务管理。

## 设置位置

代收账户设置位于：**我的 > 账户管理 > 代收账户**

## 核心功能

### 1. 启用/禁用代收

- **启用代收**：账户可以接收代收任务
- **禁用代收**：账户不会接收代收任务
- 默认状态：禁用

### 2. 金额上限设置

- **无限制（0）**：可以使用用户全部余额
- **有限额（>0）**：该账户最多只能接收指定金额的代收任务
- 例如：设置金额上限为 1000 元，该账户最多只能接收 1000 元的代收任务

### 3. 代收统计

每个代收账户会显示以下统计信息：
- **已分配金额**：已分配给该账户的代收金额
- **剩余金额**：该账户还可接收的代收金额（仅在设置金额上限时显示）
- **佣金收入**：该账户已获得的佣金总额
- **完成单数**：该账户完成的代收任务总数
- **使用进度**：显示已使用金额占上限的百分比（仅在设置金额上限时显示）

## 数据库字段

### payment_accounts 表新增字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `payin_enabled` | BOOLEAN | 是否启用该账户进行代收 |
| `payin_max_amount` | DECIMAL(15,2) | 该账户代收金额上限（0表示无限制） |
| `payin_allocated_amount` | DECIMAL(15,2) | 该账户已分配的代收金额 |
| `payin_earned_commission` | DECIMAL(15,2) | 该账户已获得的佣金总额 |
| `payin_total_count` | INTEGER | 该账户完成的代收任务总数 |

### payin_task_allocations 表新增字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `account_id` | UUID | 代收账户ID（关联 payment_accounts 表） |

## 代收任务分配逻辑

### 分配规则

1. **无限制模式**：
   - 所有代收账户的 `payin_max_amount` 都为 0
   - 使用用户全部余额进行任务分配

2. **有限额模式**：
   - 至少有一个代收账户的 `payin_max_amount` 大于 0
   - 使用所有启用账户的剩余金额之和进行任务分配
   - 剩余金额 = `payin_max_amount` - `payin_allocated_amount`

3. **账户检查**：
   - 只显示启用代收功能的账户（`payin_enabled = true`）
   - 只显示活跃状态的账户（`is_active = true`）

## 代收流程

### 1. 领取任务

1. 用户选择代收账户
2. 系统检查账户是否启用代收功能
3. 系统检查账户余额是否足够（如果设置了金额上限）
4. 领取成功后：
   - 用户余额冻结
   - 账户 `payin_allocated_amount` 增加
   - 任务记录 `account_id` 字段

### 2. 完成任务

1. 用户上传转账凭证
2. 用户确认收到款项
3. 任务完成后：
   - 用户余额解冻（返还代收金额）
   - 用户余额增加（发放佣金）
   - 账户 `payin_allocated_amount` 减少
   - 账户 `payin_earned_commission` 增加
   - 账户 `payin_total_count` 增加

## 使用示例

### 示例 1：为单个账户设置限额

用户有一个代收账户，设置金额上限为 1000 元：

```
账户 A：
  - 代收上限：1000 元
  - 已分配：600 元
  - 剩余：400 元
  - 可接收任务：金额 ≤ 400 元的任务
```

### 示例 2：多个账户组合

用户有两个代收账户：

```
账户 A：
  - 代收上限：500 元
  - 已分配：300 元
  - 剩余：200 元

账户 B：
  - 代收上限：0（无限制）
  - 已分配：100 元
  - 剩余：无限制

总可用金额：200 元 + 用户全部余额
```

### 示例 3：全部无限制

用户有三个代收账户，全部设置为无限制：

```
账户 A、B、C：
  - 代收上限：0（无限制）
  - 已分配：各不相同

总可用金额：用户全部余额
```

## 数据库迁移

在 Supabase SQL Editor 中按顺序执行以下 SQL 文件：

1. **supabase-payment-accounts-payin.sql**
   - 为 `payment_accounts` 表添加代收相关字段

2. **supabase-payin-task-account-id.sql**
   - 为 `payin_task_allocations` 表添加 `account_id` 字段

## 注意事项

1. **账户启用**：必须先启用代收功能才能接收代收任务
2. **金额限制**：设置金额上限后，该账户只能接收限额范围内的任务
3. **统计更新**：代收统计信息会在任务完成后自动更新
4. **账户关联**：领取任务时记录使用的账户，任务完成后更新该账户的统计信息

## 后续优化建议

1. 添加账户优先级设置（优先使用哪些账户）
2. 添加账户分配策略（平均分配、按比例分配等）
3. 添加账户预警（余额不足提醒）
4. 添加账户历史记录查看功能
